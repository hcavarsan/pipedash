[tools]
rust = { version = "nightly", components = "rust-src,llvm-tools,clippy,rustfmt,rustc-dev" }
node = "24"
bun = "latest"

[env]
RUST_LOG = "debug"

# ------------------------------------------------------------------------------
# Development
# ------------------------------------------------------------------------------

[tasks.dev]
description = "Full-stack with hot reload"
run = """
bunx concurrently --kill-others --names 'BACK,FRONT' -c 'magenta,cyan' \
  'cargo watch -w crates -x \"run -p pipedash-web\"' \
  'bunx wait-on http://localhost:8080/api/health --timeout 120000 && bun run dev'
"""

[tasks."dev:front"]
description = "Frontend only"
run = "bun run dev"

[tasks."dev:back"]
description = "Backend only"
run = "cargo watch -w crates -x 'run -p pipedash-web'"

[tasks."dev:tauri"]
description = "Desktop app"
run = "bun run tauri dev"

[tasks."dev:ios"]
description = "iOS app"
run = "bun run tauri ios dev"

[tasks."dev:android"]
description = "Android app"
run = "bun run tauri android dev"

# ------------------------------------------------------------------------------
# Build
# ------------------------------------------------------------------------------

[tasks.build]
description = "Production binary with embedded frontend"
depends = ["build:front"]
run = "cargo build --release -p pipedash-web"

[tasks."build:front"]
description = "Frontend assets"
run = "bun run build"

[tasks."build:tauri"]
description = "Desktop app"
run = "bun run tauri build"

[tasks."build:ios"]
description = "iOS app"
run = "bun run tauri ios build"

[tasks."build:android"]
description = "Android app"
run = "bun run tauri android build"

[tasks."build:analyze"]
description = "Frontend with bundle analysis"
run = "ANALYZE=true bun run build"

# ------------------------------------------------------------------------------
# Code Quality
# ------------------------------------------------------------------------------

[tasks.check]
description = "Type check all"
depends = ["check:front", "check:back"]

[tasks."check:front"]
run = "bun run tsc --noEmit"

[tasks."check:back"]
run = "cargo check --workspace --all-targets --all-features"

[tasks.lint]
description = "Lint all"
depends = ["lint:front", "lint:back"]

[tasks."lint:front"]
run = "bun run eslint"

[tasks."lint:back"]
run = "cargo clippy --workspace --all-targets --all-features -- -D warnings"

[tasks.fix]
description = "Auto-fix lint issues"
depends = ["fix:front", "fix:back"]

[tasks."fix:front"]
run = "bun run eslint --fix"

[tasks."fix:back"]
run = "cargo clippy --workspace --all-targets --all-features --fix --allow-dirty"

[tasks.fmt]
description = "Format all"
depends = ["fmt:front", "fmt:back"]

[tasks."fmt:front"]
run = "bun run eslint --fix"

[tasks."fmt:back"]
run = "cargo +nightly fmt --all"

[tasks."fmt:check"]
description = "Check formatting"
depends = ["fmt:front:check", "fmt:back:check"]

[tasks."fmt:front:check"]
run = "bun run eslint"

[tasks."fmt:back:check"]
run = "cargo +nightly fmt --all -- --check"

# ------------------------------------------------------------------------------
# CI / Release
# ------------------------------------------------------------------------------

[tasks.ci]
description = "Run all CI checks"
depends = ["fmt:check", "lint", "check"]

[tasks.precommit]
description = "Pre-commit hook"
run = "mise run fmt && mise run lint && mise run check"

[tasks.release]
description = "Full release build"
depends = ["ci", "build"]

[tasks."bump:patch"]
run = "cd hacks && cargo run --bin bump_version patch && cd .. && cargo update --workspace"

[tasks."bump:minor"]
run = "cd hacks && cargo run --bin bump_version minor && cd .. && cargo update --workspace"

[tasks."bump:major"]
run = "cd hacks && cargo run --bin bump_version major && cd .. && cargo update --workspace"

# ------------------------------------------------------------------------------
# Setup
# ------------------------------------------------------------------------------

[tasks.install]
description = "Install dependencies"
run = "bun install"

[tasks."install:ios"]
description = "Initialize iOS"
run = "bun run tauri ios init"

[tasks."install:android"]
description = "Initialize Android"
run = "bun run tauri android init"

# ------------------------------------------------------------------------------
# Examples
# ------------------------------------------------------------------------------

[tasks."examples:sqlite:up"]
description = "Start SQLite example"
run = "DOCKER_BUILDKIT=1 docker compose -f examples/sqlite/docker-compose.yml build --progress=plain && docker compose -f examples/sqlite/docker-compose.yml up"

[tasks."examples:sqlite:down"]
description = "Stop SQLite example"
run = "docker compose -f examples/sqlite/docker-compose.yml down -v"

[tasks."examples:postgres:up"]
description = "Start PostgreSQL example"
run = "DOCKER_BUILDKIT=1 docker compose -f examples/postgres/docker-compose.yml build --progress=plain && docker compose -f examples/postgres/docker-compose.yml up"

[tasks."examples:postgres:down"]
description = "Stop PostgreSQL example"
run = "docker compose -f examples/postgres/docker-compose.yml down -v"

# ------------------------------------------------------------------------------
# Utils
# ------------------------------------------------------------------------------

[tasks.clean]
description = "Remove build artifacts"
run = "cargo clean && rm -rf dist node_modules/.vite"

[tasks.knip]
description = "Find unused code"
run = "bun run knip"

[tasks.icons]
description = "Generate app icons"
run = "cargo run --bin generate_icons"

[tasks.deps]
description = "Update dependencies (major)"
run = "bunx taze major -I"

[tasks."deps:minor"]
description = "Update dependencies (minor)"
run = "bunx taze minor -w"
