name: Release
on:
  push:
    tags:
      - "v[0-9]+.[0-9]+.[0-9]+*"

permissions:
  contents: read
  statuses: write

env:
  TAURI_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
  TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
  TAURI_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
  TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
  VITE_ENV: "production"
  TAURI_DEBUG: "false"

jobs:
  validate-version:
    runs-on: ubuntu-22.04
    steps:
      - name: Validate version format
        run: |
          if ! [[ ${{ github.ref_name }} =~ ^v[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9.]+)?$ ]]; then
            echo "Invalid version format. Must be vX.Y.Z or vX.Y.Z-suffix"
            exit 1
          fi

  create-release-draft:
    needs:
    - validate-version
    permissions:
      contents: write
    runs-on: ubuntu-22.04
    outputs:
      release_id: ${{ steps.create_release.outputs.id }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@09d2acae674a48949e3602304ab46fd20ae0c42f
        with:
          fetch-depth: 0

      - name: Check existing release
        id: check_release
        continue-on-error: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          release_id=$(gh api repos/${{ github.repository }}/releases/tags/${{ github.ref_name }} --jq .id 2>/dev/null || echo "")
          if [[ "$release_id" =~ ^[0-9]+$ ]]; then
            echo "Release already exists with ID: $release_id"
            echo "release_exists=true" >> "$GITHUB_OUTPUT"
            echo "existing_release_id=$release_id" >> "$GITHUB_OUTPUT"
          else
            echo "Release does not exist"
            echo "release_exists=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Create release draft
        id: create_release
        if: steps.check_release.outputs.release_exists != 'true'
        uses: softprops/action-gh-release@72f2c25fcb47643c292f7107632f7a47c1df5cd8
        with:
          tag_name: ${{ github.ref_name }}
          name: "Pipedash - ${{ github.ref_name }}"
          draft: true
          prerelease: false
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set release ID output
        run: |
          if [ "${{ steps.check_release.outputs.release_exists }}" == "true" ]; then
            echo "id=${{ steps.check_release.outputs.existing_release_id }}" >> "$GITHUB_OUTPUT"
          else
            echo "id=${{ steps.create_release.outputs.id }}" >> "$GITHUB_OUTPUT"
          fi

  pipedash:
    needs: create-release-draft
    permissions:
      contents: write
    strategy:
      matrix:
        include:
          - os: ubuntu-22.04
            arch: arm64
            runner: ubicloud-standard-4-arm-ubuntu-2204
            rust_target: aarch64-unknown-linux-gnu
            tauri_args: "--target aarch64-unknown-linux-gnu --bundles deb,rpm,appimage --verbose"
          - os: ubuntu-22.04
            arch: amd64
            rust_target: x86_64-unknown-linux-gnu
            tauri_args: "--target x86_64-unknown-linux-gnu --bundles deb,rpm,appimage --verbose"
          - os: macos-latest
            arch: universal
            rust_target: universal-apple-darwin
            tauri_args: "--target universal-apple-darwin --bundles dmg,app --verbose"
          - os: windows-latest
            arch: x86
            rust_target: i686-pc-windows-msvc
            tauri_args: "--target i686-pc-windows-msvc --bundles nsis --verbose"
            msvc_arch: x86
          - os: windows-latest
            arch: x86_64
            rust_target: x86_64-pc-windows-msvc
            tauri_args: "--target x86_64-pc-windows-msvc --bundles nsis --verbose"
            msvc_arch: x64
          - os: windows-latest
            arch: arm64
            rust_target: aarch64-pc-windows-msvc
            tauri_args: "--target aarch64-pc-windows-msvc --bundles nsis --verbose"

    runs-on: ${{ matrix.runner || matrix.os }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@09d2acae674a48949e3602304ab46fd20ae0c42f

      - name: Install mise
        uses: jdx/mise-action@v3
        with:
          install: false
          cache: true

      - name: Install mise tools
        run: mise install

      - name: Install dependencies
        run: mise run install

      - name: Set up Visual Studio shell
        if: matrix.os == 'windows-latest' && matrix.arch == 'arm64'
        uses: TheMrMilchmann/setup-msvc-dev@fb19abb8a41b3cf0340f5d1be17d420309232be6
        with:
          arch: amd64_arm64


      - name: Setup platform-specific dependencies
        if: matrix.os == 'ubuntu-22.04'
        run: |
          sudo apt-get update
          sudo apt install -y \
              build-essential \
              curl \
              wget \
              file \
              libxdo-dev \
              libssl-dev \
              libayatana-appindicator3-dev \
              librsvg2-dev \
              libwebkit2gtk-4.1-dev \
              patchelf \
              xdg-utils

      - name: Reconfigure Rust targets
        run: |
          if [ "${{ matrix.os }}" == "macos-latest" ]; then
            rustup target add aarch64-apple-darwin x86_64-apple-darwin
          else
            rustup target add ${{ matrix.rust_target }}
          fi
        shell: bash

      - name: Install NASM on Windows
        if: matrix.os == 'windows-latest'
        run: choco install nasm

      - name: Build pipedash Desktop App
        uses: tauri-apps/tauri-action@e834788a94591d81e3ae0bd9ec06366f5afb8994
        id: tauri_build
        continue-on-error: true
        env:
          RUSTFLAGS: '-C link-arg=-s'
          AWS_LC_SYS_CMAKE_CFLAGS: ${{ matrix.os == 'windows-latest' && '/std:c11' || '' }}
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          NODE_OPTIONS: --max-old-space-size=6000
          ENABLE_CODE_SIGNING: ${{ secrets.APPLE_CERTIFICATE }}
          APPLE_CERTIFICATE: ${{ secrets.APPLE_CERTIFICATE }}
          APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
          APPLE_SIGNING_IDENTITY: ${{ secrets.APPLE_SIGNING_IDENTITY }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_PASSWORD: ${{ secrets.APPLE_PASSWORD }}
        with:
          tagName: ${{ github.ref_name }}
          releaseName: "Pipedash - ${{ github.ref_name }}"
          releaseBody: "See the assets to download this version and install."
          releaseDraft: true
          prerelease: false
          args: ${{ matrix.tauri_args }}

      - name: Retry Build on Failure
        if: steps.tauri_build.outcome == 'failure'
        uses: tauri-apps/tauri-action@e834788a94591d81e3ae0bd9ec06366f5afb8994
        env:
          RUSTFLAGS: '-C link-arg=-s'
          AWS_LC_SYS_CMAKE_CFLAGS: ${{ matrix.os == 'windows-latest' && '/std:c11' || '' }}
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          NODE_OPTIONS: --max-old-space-size=6000
          ENABLE_CODE_SIGNING: ${{ secrets.APPLE_CERTIFICATE }}
          APPLE_CERTIFICATE: ${{ secrets.APPLE_CERTIFICATE }}
          APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
          APPLE_SIGNING_IDENTITY: ${{ secrets.APPLE_SIGNING_IDENTITY }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_PASSWORD: ${{ secrets.APPLE_PASSWORD }}
        with:
          tagName: ${{ github.ref_name }}
          releaseName: "Pipedash - ${{ github.ref_name }}"
          releaseBody: "See the assets to download this version and install."
          releaseDraft: true
          prerelease: false
          args: ${{ matrix.tauri_args }}

  docker-publish:
    needs: [create-release-draft]
    permissions:
      contents: read
      packages: write
    runs-on: ubuntu-22.04
    if: startsWith(github.ref, 'refs/tags/v')
    steps:
      - name: Checkout repository
        uses: actions/checkout@09d2acae674a48949e3602304ab46fd20ae0c42f

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.repository_owner }}/pipedash-web
          tags: |
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=sha
            type=raw,value=latest,enable=${{ !contains(github.ref, '-beta') && !contains(github.ref, '-alpha') }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          platforms: linux/amd64,linux/arm64
          context: .
          file: ./docker/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  publish-cargo-crates:
    needs: [create-release-draft]
    permissions:
      contents: read
    runs-on: ubuntu-22.04
    if: |
      startsWith(github.ref, 'refs/tags/v') &&
      !contains(github.ref, '-beta') &&
      !contains(github.ref, '-alpha')
    steps:
      - name: Checkout repository
        uses: actions/checkout@09d2acae674a48949e3602304ab46fd20ae0c42f

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@nightly

      - name: Cache Rust
        uses: swatinem/rust-cache@v2

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y pkg-config libssl-dev

      - name: Publish crates to crates.io
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}
        run: |
          publish_crate() {
            local crate_path="$1"
            local crate_name=$(basename "$crate_path")
            local max_retries=3
            local retry_delay=30

            echo "Publishing $crate_name..."
            cd "$crate_path"

            for attempt in $(seq 1 $max_retries); do
              echo "Attempt $attempt/$max_retries for $crate_name"

              if cargo publish --token $CARGO_REGISTRY_TOKEN; then
                echo "Successfully published $crate_name"
                cd - > /dev/null
                return 0
              fi

              # Check if already published
              if cargo publish --dry-run 2>&1 | grep -q "already uploaded\|already exists"; then
                echo "$crate_name already published, skipping"
                cd - > /dev/null
                return 0
              fi

              if [ $attempt -lt $max_retries ]; then
                echo "Retrying $crate_name in ${retry_delay}s..."
                sleep $retry_delay
                retry_delay=$((retry_delay * 2))
              else
                echo "Failed to publish $crate_name after $max_retries attempts"
                cd - > /dev/null
                return 1
              fi
            done
          }

          # Publish in dependency order with rate limiting
          crates=(
            "crates/pipedash-plugin-api"
            "crates/pipedash-plugin-github"
            "crates/pipedash-plugin-gitlab"
            "crates/pipedash-plugin-bitbucket"
            "crates/pipedash-plugin-buildkite"
            "crates/pipedash-plugin-jenkins"
            "crates/pipedash-plugin-tekton"
            "crates/pipedash-plugin-argocd"
            "crates/pipedash-core"
            "crates/pipedash-web"
          )

          for crate in "${crates[@]}"; do
            publish_crate "$crate"
            # Wait 60s between publishes to avoid rate limiting
            if [ "$crate" != "crates/pipedash-web" ]; then
              echo "Waiting 60s to avoid rate limiting..."
              sleep 60
            fi
          done

          echo "All crates published successfully!"

  update-release:
    needs: [pipedash, create-release-draft]
    permissions:
      contents: write
    runs-on: ubuntu-22.04
    if: |
      startsWith(github.ref, 'refs/tags/v') &&
      !contains(github.ref, '-beta') &&
      !contains(github.ref, '-alpha')
    steps:
      - name: Checkout
        uses: actions/checkout@09d2acae674a48949e3602304ab46fd20ae0c42f
        with:
          fetch-depth: 0

      - name: Generate changelog
        uses: orhun/git-cliff-action@104a6cf3c9aa0fdfe4eab129f9c1900e1eb8f7fd
        id: git-cliff
        with:
          config: cliff.toml
          args: --latest --strip header
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Update release notes
        uses: actions/github-script@f28e40c7f34bde8b3046d885e986cb6290c5673b
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            try {
              await github.rest.repos.updateRelease({
                owner: context.repo.owner,
                repo: context.repo.repo,
                release_id: ${{ needs.create-release-draft.outputs.release_id }},
                body: `${{ steps.git-cliff.outputs.content }}`,
                tag_name: process.env.GITHUB_REF_NAME,
                name: `Pipedash - ${process.env.GITHUB_REF_NAME}`
              });
            } catch (error) {
              console.error('Failed to update release notes:', error);
              if (error.status === 404) {
                console.log('Release not found, retrying after short delay...');
                await new Promise(resolve => setTimeout(resolve, 5000));
                await github.rest.repos.updateRelease({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  release_id: ${{ needs.create-release-draft.outputs.release_id }},
                  body: `${{ steps.git-cliff.outputs.content }}`,
                  tag_name: process.env.GITHUB_REF_NAME,
                  name: `Pipedash - ${process.env.GITHUB_REF_NAME}`
                });
              } else {
                throw error;
              }
            }

      - name: Publish release
        uses: eregon/publish-release@70a6784870e7313347f6aa7fa7783786f2c1692f
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          release_id: ${{ needs.create-release-draft.outputs.release_id }}
